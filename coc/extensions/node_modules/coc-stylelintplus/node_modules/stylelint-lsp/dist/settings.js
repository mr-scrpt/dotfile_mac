"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultClientSettings = void 0;
const tslib_1 = require("tslib");
const vscode_uri_1 = require("vscode-uri");
const stylelint_1 = tslib_1.__importDefault(require("stylelint"));
const resolve_from_1 = tslib_1.__importDefault(require("resolve-from"));
const path_1 = tslib_1.__importDefault(require("path"));
exports.defaultClientSettings = {
    autoFixOnFormat: false,
    autoFixOnSave: false,
    config: undefined,
    configFile: undefined,
    configOverrides: undefined,
    enable: true,
    validateOnSave: true,
    validateOnType: true,
};
class Settings {
    constructor(connection) {
        this.connection = connection;
        this.supportsConfigurationRequests = false;
        this.globalSettings = { ...exports.defaultClientSettings };
        this.documentToSettings = new Map();
        this.pathToStylelint = new Map();
        this.failedDocuments = new Set();
        this._supportedCodeActionLiterals = [];
    }
    initialize(capabilities) {
        this.supportsConfigurationRequests = Boolean(capabilities.workspace && capabilities.workspace.configuration);
        this._supportedCodeActionLiterals =
            capabilities.textDocument &&
                capabilities.textDocument.codeAction &&
                capabilities.textDocument.codeAction.codeActionLiteralSupport
                ? capabilities.textDocument.codeAction.codeActionLiteralSupport
                    .codeActionKind.valueSet
                : [];
    }
    resolve(document) {
        const uri = document.uri;
        if (!this.supportsConfigurationRequests) {
            return Promise.resolve({
                ...this.globalSettings,
                lint: this.lintFunc(uri, stylelint_1.default),
            });
        }
        const cached = this.documentToSettings.get(uri);
        if (cached) {
            return cached;
        }
        const promise = this.connection.workspace
            .getConfiguration({ scopeUri: uri, section: "" })
            .then((settings) => {
            const stylelint = this.resolveStylelint(uri);
            return {
                ...exports.defaultClientSettings,
                ...settings.stylelintplus,
                lint: this.lintFunc(uri, stylelint),
            };
        });
        this.documentToSettings.set(uri, promise);
        return promise;
    }
    lintFunc(uri, stylelint) {
        return async (...args) => {
            if (!this.failedDocuments.has(uri)) {
                try {
                    return await stylelint.lint(...args);
                }
                catch (error) {
                    console.error(`Error when trying to validate ${uri}`, error);
                    this.failedDocuments.add(uri);
                }
            }
            return {
                errored: true,
                output: "",
                results: [],
            };
        };
    }
    resolveStylelint(uri) {
        let stylelint = stylelint_1.default;
        const parsedUri = vscode_uri_1.URI.parse(uri);
        if (parsedUri.scheme === "file") {
            const dirname = path_1.default.dirname(parsedUri.fsPath);
            const stylelintPath = resolve_from_1.default.silent(dirname, "stylelint");
            if (stylelintPath) {
                const maybeStylelint = this.pathToStylelint.get(stylelintPath);
                if (maybeStylelint) {
                    stylelint = maybeStylelint;
                }
                else {
                    this.connection.tracer.log(`stylelint found at ${stylelintPath}`);
                    stylelint = require(stylelintPath);
                    this.pathToStylelint.set(stylelintPath, stylelint);
                }
            }
        }
        return stylelint;
    }
    clientConfigurationChanged(params) {
        if (this.supportsConfigurationRequests) {
            this.documentToSettings.clear();
        }
        else if (params.settings.stylelintplus) {
            this.globalSettings = {
                ...exports.defaultClientSettings,
                ...params.settings.stylelintplus,
            };
        }
    }
    clearFailedDocuments() {
        this.failedDocuments.clear();
    }
    closeDocument(document) {
        this.documentToSettings.delete(document.uri);
    }
    get supportedCodeActionLiterals() {
        return this._supportedCodeActionLiterals;
    }
}
exports.default = Settings;
